<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myprofile">

	<select id="profile"  parameterType="int" resultType="MyprofileDto">
	select 
		P.attach_no,M.*
	from
    	profile_attach P
	inner join 
    	mem M
	on 
		P.mem_no=M.mem_no
	where 
		M.mem_no= #{mem_no}
	</select>
	<!--회원당 게시물 번호-->
	<select id="reviewCnt" parameterType="int" resultType="int">
		select
			count(*)
		from 
			review
		where 
			mem_no=#{memNo}
	</select>
	<!-- 한 회원의 리뷰 정보를 가지고 온다.  --> 
	<select id="review" parameterType="int" resultType="ReviewDto">
		select 
			* 
		from 
			review 
		where
			mem_no=#{memNo}
	</select>
	<!-- 북마크 --> 
	<select id="bookmark" parameterType="int" resultType="ProfileBookmarkVO">
		select
    		B.*,R.like_cnt
		from
    		bookmark B
		inner join
    		review R
		on
			B.review_no=R.review_no
		where 
			B.mem_no=#{memNo}
		order by B.bookmark_time
	</select>
	<!-- 좋아요 -->
	<select id="like" parameterType="int" resultType="ProfileLikeVO">
		select 
    		L.*,R.like_cnt 
		from 
    		likes L
		left outer join 
    		review R
		on
			L.review_no=R.review_no
		where 
			L.mem_no=#{memNo}
	</select>
	<!-- 리뷰당사진갯수 -->
	<select id="photocnt" parameterType="int" resultType="int">
		select
	 		count(*)
	 	 from 
	 	 	review_attach 
	 	 where 
	 	 	review_no={reviewNo}
	</select>
	<select id="memprofile" parameterType="int" resultType="ProfileMemVO">
		select
        	distinct
        	M.mem_no,
        	M.mem_nick,
        	M.mem_intro,
        	coalesce(RC.cnt, 0) review_cnt,
        	coalesce(FP.cnt2, 0) follow_cnt,
        	coalesce(FT.cnt3, 0) follower_cnt
        
    	from (
    		 select * from mem where mem_no=#{memNo})M 
    left outer join review R on M.mem_no=R.mem_no
    left outer join(
    		select 
    			mem_no,count(mem_no) cnt
    		 from 
    		 	review
    		 group by mem_no
    )RC on M.mem_no=RC.mem_no
    left outer join(
        select
            passive_mem_no ,count(passive_mem_no)cnt2
        from 
            follow 
        group by passive_mem_no)
        FP on M.mem_no=FP.passive_mem_no
    left outer join(
        select 
            active_mem_no, count(active_mem_no) cnt3
        from 
            follow 
        group by active_mem_no
    ) FT on M.mem_no=FT.active_mem_no
	</select>

</mapper>